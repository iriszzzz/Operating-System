#!/usr/bin/env python3
import re # 正則表達式模組
from gradelib import *
from collections import defaultdict

r = Runner(save("xv6_aging_strict.out"))

def parse(outputs: str):
    parsed = defaultdict(list)
    for line in outputs.splitlines():
        m = re.search(r'procstatelog: pid=(\d+), ticks=(\d+), state="(\w+)", priority=(\d+)', line)
        if not m:
            continue
        pid = int(m.group(1))
        ticks = int(m.group(2))
        state = m.group(3).lower()
        pr = int(m.group(4))
        parsed[pid].append({"ticks": ticks, "state": state, "priority": pr})
    return parsed

@test(20, "aging-strict")
def test_aging():
    r.run_qemu(shell_script(["mp2-aging 100"])) # 執行 100 個單位時間
    out = r.qemu.output
    parsed = parse(out)

    assert parsed, "\nNo procstatelog lines found."

    # For each pid, we want to find a pair of entries (i, j) with:
    # ticks_j >= ticks_i + 20  AND priority_j > priority_i
    found_any = False
    details = []

    for pid, entries in parsed.items():
        entries_sorted = sorted(entries, key=lambda e: e["ticks"])
        n = len(entries_sorted)
        for i in range(n):
            ti = entries_sorted[i]["ticks"]
            pi = entries_sorted[i]["priority"]
            for j in range(i+1, n):
                tj = entries_sorted[j]["ticks"]
                pj = entries_sorted[j]["priority"]
                if tj < ti + 20:
                    continue
                if pj > pi:
                    # check states between i and j the process wasn't exiting
                    mid_states = {e["state"] for e in entries_sorted[i:j+1]}
                    details.append((pid, ti, pi, tj, pj, mid_states))
                    found_any = True
                    break
            if found_any:
                break
        if found_any:
            break

    assert found_any, (
        "Aging not observed deterministically: no process shows priority increase "
        "by at least 1 after waiting >= 20 ticks. Parsed details: " + str(details[:3])
    )

    if details:
        pid, ti, pi, tj, pj, mid = details[0]
        print(f"\nAging: pid={pid}, priority {pi} → {pj}, ticks {ti} → {tj}, states={mid}")

run_tests()
